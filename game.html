<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <title>게임 페이지</title>

    <style>
        .problem-img {
            width: 200px;
            height: auto;
            display: none; /* 모든 이미지 숨김 */
        }
        .selected {
            display: block; /* 선택된 이미지만 표시 */
        }
        .indicator-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: gray;
            display: inline-block;
            margin: 0 5px;
        }
        .indicator-circle.selected {
            background-color: green;
        }
    </style>

    <script>
        let mateList;
        let tenMateList = [];
        let count = 0;
        let currentProblemIndex = 0; // 현재 문제의 인덱스

        $(document).ready(function () {
            addProblems();  // 게임 페이지 시작
            $("#answer").focus(); // 정답 입력란에 포커스 설정
            $("#answer").keypress(function(event) { // 엔터키 눌렀을 때 제출
                if (event.which === 13) { // 13은 엔터키의 키코드
                    submitAnswer();
                }
            });
        });

        function addProblems() {
            $.ajax({
                type: "GET",
                url: "/api/list",
                data: {},
                success: function (response) {
                    if (response['result'] == 'success') {
                        mateList = response['mateList']; // DB에서 전체 리스트를 받아온다
                        let randomInt = generateRandomIndexes(10, mateList.length);

                        for (let i of randomInt){
                            tenMateList.push(mateList[i]);
                        }

                        // 문제 이미지와 표시기 추가
                        for (let i = 0; i < tenMateList.length; i++){
                            $('#problem-box').append('<img src="' + tenMateList[i]['img'] + '" alt="" class="problem-img">');
                            $('#problem-indicators').append('<div class="indicator-circle"></div>');
                        }
                        
                        $(".problem-img").eq(0).addClass("selected"); 
                        $(".indicator-circle").eq(0).addClass("selected"); 
                    }
                }
            });
        }

        function generateRandomIndexes(n, max) {
            let indexes = [];
            while (indexes.length < n) {
                let randomIndex = Math.floor(Math.random() * max);
                if (!indexes.includes(randomIndex)) {
                    indexes.push(randomIndex);
                }
            }
            return indexes;
        }

        function submitAnswer() {
            let answer = $("#answer").val().trim(); // 입력값 공백 제거
            let correctAnswer = tenMateList[currentProblemIndex]['name'];

            if (answer.toLowerCase() === correctAnswer.toLowerCase()) {
                count += 1;
                $("#feedback").text("정답입니다!");
            } else {
                $("#feedback").text("오답입니다!");
            }

            currentProblemIndex++;
            if (currentProblemIndex < tenMateList.length) {
                // 다음 문제로 이동
                $(".problem-img").removeClass("selected");
                $(".indicator-circle").removeClass("selected");
                $(".problem-img").eq(currentProblemIndex).addClass("selected");
                $(".indicator-circle").eq(currentProblemIndex).addClass("selected");
                $("#answer").val("").focus(); // 정답 입력란 초기화 및 포커스 설정
            } else {
                // 모든 문제를 다 푼 경우 게임 종료
                $("#answer").prop('disabled', true); // 정답 입력란 비활성화
                $("#feedback").text("게임 종료! 당신의 점수는 " + count + "점 입니다.");
                $("#restart").show(); // 게임 재시작 버튼 표시
            }
        }

        function restartGame() {
            tenMateList = []; // 게임을 재시작하기 위해 변수 초기화
            count = 0;
            currentProblemIndex = 0;
            $("#problem-box").empty(); // 문제 이미지 및 표시기 제거
            $("#problem-indicators").empty();
            $("#feedback").text(""); // 피드백 메시지 초기화
            $("#answer").prop('disabled', false).val("").focus(); // 정답 입력란 초기화 및 활성화
            $("#restart").hide(); // 게임 재시작 버튼 숨김
            addProblems(); // 문제 다시 추가
        }
    </script>
</head>
<body>
    <div>
        <div id="problem-indicators"></div>
        <div>이미지와 맞는 이름을 입력하세요.</div> 
        <div id="problem-box"></div>
        <div class="form-group">
            <label for="answer">정답 : </label>
            <input type="text" id="answer">
            <button onclick="submitAnswer()">제출</button>
            <div id="feedback"></div> <!-- 정답 피드백 표시 -->
        </div>
        <button id="restart" onclick="restartGame()" style="display:none;">게임 재시작</button>
    </div>
</body>
</html>
